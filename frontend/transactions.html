<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction History - Banking Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .slide-in { animation: slideIn 0.4s ease-out; }
        tr { transition: all 0.3s ease; }
        tr:hover { background-color: #f3f4f6; transform: scale(1.01); }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-orange-50 min-h-screen">
    <nav class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-4 shadow-lg slide-in">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold cursor-pointer flex items-center hover:scale-105 transition" onclick="location.href='dashboard.html'">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Banking Portal
            </h1>
            <button onclick="logout()" class="bg-red-700 hover:bg-red-800 px-4 py-2 rounded-lg transition transform hover:scale-105">Logout</button>
        </div>
    </nav>

    <div class="container mx-auto mt-8 px-4">
        <div class="flex justify-between items-center mb-6 fade-in">
            <h2 class="text-4xl font-bold bg-gradient-to-r from-orange-600 to-red-600 bg-clip-text text-transparent flex items-center">
                <svg class="w-8 h-8 mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                Transaction History
            </h2>
            <div class="flex gap-4">
                <select id="filterType" class="border-2 border-orange-200 focus:border-orange-500 rounded-xl px-4 py-2 transition">
                    <option value="all">All Types</option>
                    <option value="DEPOSIT">Deposits</option>
                    <option value="WITHDRAWAL">Withdrawals</option>
                    <option value="TRANSFER">Transfers</option>
                </select>
                <select id="filterAccount" class="border-2 border-orange-200 focus:border-orange-500 rounded-xl px-4 py-2 transition">
                    <option value="all">All Accounts</option>
                </select>
                <button onclick="applyFilters()" class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-bold py-2 px-6 rounded-xl transition transform hover:scale-105 shadow-lg">
                    Apply Filters
                </button>
                <button onclick="exportTransactions()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-2 px-6 rounded-xl transition transform hover:scale-105 shadow-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden fade-in">
            <table class="min-w-full">
                <thead class="bg-gradient-to-r from-orange-600 to-red-600 text-white">
                    <tr>
                        <th class="py-4 px-6 text-left font-semibold">Transaction ID</th>
                        <th class="py-4 px-6 text-left font-semibold">Date & Time</th>
                        <th class="py-4 px-6 text-left font-semibold">Account Number</th>
                        <th class="py-4 px-6 text-left font-semibold">Type</th>
                        <th class="py-4 px-6 text-left font-semibold">Amount</th>
                        <th class="py-4 px-6 text-left font-semibold">Balance After</th>
                        <th class="py-4 px-6 text-left font-semibold">Description</th>
                        <th class="py-4 px-6 text-left font-semibold">Status</th>
                    </tr>
                </thead>
                <tbody id="transactionTable">
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">Loading transactions...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="assets/js/auth.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8080/api';
        let allTransactions = [];
        let allAccounts = [];

        async function loadAccounts() {
            try {
                const response = await fetch(`${API_BASE_URL}/accounts`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    allAccounts = await response.json();
                    const filterAccount = document.getElementById('filterAccount');
                    allAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.accountNumber;
                        const customerName = account.customer ? `${account.customer.firstName} ${account.customer.lastName}` : 'N/A';
                        option.textContent = `${account.accountNumber} - ${customerName}`;
                        filterAccount.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        async function loadTransactions() {
            try {
                console.log('Loading transactions...');
                const response = await fetch(`${API_BASE_URL}/transactions`, {
                    headers: getAuthHeaders()
                });
                console.log('Transaction response status:', response.status);
                if (response.ok) {
                    allTransactions = await response.json();
                    console.log('Loaded transactions:', allTransactions.length);
                    displayTransactions(allTransactions);
                } else {
                    console.error('Failed to load transactions');
                    document.getElementById('transactionTable').innerHTML = 
                        '<tr><td colspan="8" class="text-center py-8 text-gray-500">No transactions found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionTable').innerHTML = 
                    '<tr><td colspan="8" class="text-center py-8 text-red-500">Error loading transactions</td></tr>';
            }
        }

        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionTable');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No transactions found</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.map(txn => `
                <tr class="hover:bg-gray-50">
                    <td class="py-3 px-6 font-mono text-sm">${txn.transactionId || 'N/A'}</td>
                    <td class="py-3 px-6 text-sm">${formatDateTime(txn.timestamp)}</td>
                    <td class="py-3 px-6 font-mono text-sm">${txn.account ? txn.account.accountNumber : 'N/A'}</td>
                    <td class="py-3 px-6">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${getTypeColor(txn.transactionType || txn.type)}">
                            ${txn.transactionType || txn.type}
                        </span>
                    </td>
                    <td class="py-3 px-6 font-semibold ${txn.amount >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${txn.amount >= 0 ? '+' : ''}₹${Math.abs(txn.amount).toFixed(2)}
                    </td>
                    <td class="py-3 px-6 font-semibold">₹${txn.balanceAfter.toFixed(2)}</td>
                    <td class="py-3 px-6 text-sm">${txn.description || '-'}</td>
                    <td class="py-3 px-6">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${getStatusColor(txn.status)}">
                            ${txn.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const accountFilter = document.getElementById('filterAccount').value;

            let filtered = allTransactions;

            if (typeFilter !== 'all') {
                filtered = filtered.filter(txn => (txn.transactionType || txn.type) === typeFilter);
            }

            if (accountFilter !== 'all') {
                filtered = filtered.filter(txn => txn.account && txn.account.accountNumber === accountFilter);
            }

            displayTransactions(filtered);
        }

        function exportTransactions() {
            const typeFilter = document.getElementById('filterType').value;
            const accountFilter = document.getElementById('filterAccount').value;

            let filtered = allTransactions;

            if (typeFilter !== 'all') {
                filtered = filtered.filter(txn => (txn.transactionType || txn.type) === typeFilter);
            }

            if (accountFilter !== 'all') {
                filtered = filtered.filter(txn => txn.account && txn.account.accountNumber === accountFilter);
            }

            // Create CSV content
            let csv = 'Transaction ID,Date & Time,Account Number,Type,Amount,Balance After,Description,Status\n';
            filtered.forEach(txn => {
                csv += `"${txn.transactionId}","${formatDateTime(txn.timestamp)}","${txn.account.accountNumber}","${txn.type}","${txn.amount}","${txn.balanceAfter}","${txn.description || ''}","${txn.status}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getTypeColor(type) {
            const colors = {
                'DEPOSIT': 'bg-green-100 text-green-800',
                'WITHDRAWAL': 'bg-red-100 text-red-800',
                'TRANSFER': 'bg-blue-100 text-blue-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function getStatusColor(status) {
            const colors = {
                'SUCCESS': 'bg-green-100 text-green-800',
                'FAILED': 'bg-red-100 text-red-800',
                'PENDING': 'bg-yellow-100 text-yellow-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Initialize
        checkAuth();
        loadAccounts();
        loadTransactions();
    </script>
</body>
</html>
